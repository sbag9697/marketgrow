<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MarketGrow 로그인 - SNS 마케팅 서비스 이용을 위한 로그인">
    <title>로그인 - MarketGrow</title>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="로그인 - MarketGrow">
    <meta property="og:description" content="MarketGrow 계정으로 로그인하여 SNS 마케팅 서비스를 이용하세요.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://melodious-banoffee-c450ea.netlify.app/login.html">
    <meta property="og:site_name" content="MarketGrow">
    <meta property="og:locale" content="ko_KR">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="로그인 - MarketGrow">
    <meta name="twitter:description" content="MarketGrow 계정으로 로그인하세요">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://melodious-banoffee-c450ea.netlify.app/login.html">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mobile-fix.css">
    <link rel="stylesheet" href="auth.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Auth Check -->
    <script src="js/auth-check.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <div class="logo-icon">MG</div>
                <h2><a href="index.html">MarketGrow</a></h2>
            </div>
            <ul class="nav-menu">
                <li><a href="login.html" class="active">로그인</a></li>
                <li><a href="signup.html">가입하기</a></li>
                <li><a href="order-method.html">주문방법</a></li>
                <li><a href="services.html">서비스목록</a></li>
                <li><a href="blog.html">마케팅 블로그</a></li>
                <li><a href="video-keywords.html">영상키워드노출</a></li>
                <li><a href="live-keywords.html">라이브키워드노출</a></li>
            </ul>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Login Section -->
    <section class="auth-section">
        <div class="container">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-header">
                        <h1>로그인</h1>
                        <p>MarketGrow 계정으로 로그인하세요</p>
                    </div>

                    <form class="auth-form" id="loginForm">
                        <div class="form-group">
                            <label for="username">아이디 또는 이메일</label>
                            <div class="input-group">
                                <i class="fas fa-user"></i>
                                <input type="text" id="username" name="username" placeholder="아이디 또는 이메일을 입력하세요" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password">비밀번호</label>
                            <div class="input-group">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요" required>
                                <button type="button" class="password-toggle" onclick="togglePassword()">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-options">
                            <label class="checkbox-group">
                                <input type="checkbox" id="remember" name="remember">
                                <span class="checkmark"></span>
                                로그인 상태 유지
                            </label>
                            <a href="#" class="forgot-link" onclick="showForgotPassword()">비밀번호를 잊으셨나요?</a>
                        </div>

                        <button type="submit" class="auth-btn primary">
                            <i class="fas fa-sign-in-alt"></i>
                            로그인
                        </button>

                        <div class="divider">
                            <span>또는</span>
                        </div>

                        <div class="social-login">
                            <button type="button" class="social-btn kakao" id="kakaoLoginBtn">
                                <i class="fas fa-comment"></i>
                                카카오톡으로 로그인
                            </button>
                            <button type="button" class="social-btn google" id="googleLoginBtn">
                                <i class="fab fa-google"></i>
                                구글로 로그인
                            </button>
                            <button type="button" class="social-btn naver" id="naverLoginBtn">
                                <i class="fas fa-n"></i>
                                네이버로 로그인
                            </button>
                        </div>

                        <div class="auth-footer">
                            <p>아직 계정이 없으신가요? <a href="signup.html">회원가입</a></p>
                        </div>
                    </form>
                </div>

                <!-- Login Benefits -->
                <div class="benefits-card">
                    <h3>로그인하면 이런 혜택이!</h3>
                    <ul class="benefits-list">
                        <li>
                            <i class="fas fa-chart-line"></i>
                            <div>
                                <h4>실시간 성과 분석</h4>
                                <p>주문한 서비스의 진행 상황을 실시간으로 확인</p>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-history"></i>
                            <div>
                                <h4>주문 내역 관리</h4>
                                <p>과거 주문 내역과 결제 정보를 한 눈에 확인</p>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-coins"></i>
                            <div>
                                <h4>적립금 혜택</h4>
                                <p>주문 시마다 적립금 지급 및 할인 혜택</p>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-bell"></i>
                            <div>
                                <h4>알림 서비스</h4>
                                <p>서비스 완료, 프로모션 등 중요한 소식을 알림</p>
                            </div>
                        </li>
                        <li>
                            <i class="fas fa-crown"></i>
                            <div>
                                <h4>VIP 회원 혜택</h4>
                                <p>등급별 할인율과 전용 고객지원 서비스</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Links -->
    <section class="quick-links">
        <div class="container">
            <h3>빠른 링크</h3>
            <div class="links-grid">
                <a href="services.html" class="quick-link">
                    <i class="fas fa-list"></i>
                    <span>서비스 목록</span>
                </a>
                <a href="order-method.html" class="quick-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>주문 방법</span>
                </a>
                <a href="blog.html" class="quick-link">
                    <i class="fas fa-blog"></i>
                    <span>마케팅 블로그</span>
                </a>
                <a href="#" class="quick-link" onclick="showSupport()">
                    <i class="fas fa-headset"></i>
                    <span>고객 지원</span>
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>MarketGrow</h3>
                    <p>24시간 SNS 마케팅 전문 서비스</p>
                </div>
                <div class="footer-links">
                    <h4>서비스</h4>
                    <ul>
                        <li><a href="services.html">전체 서비스</a></li>
                        <li><a href="order-method.html">주문 방법</a></li>
                        <li><a href="blog.html">마케팅 블로그</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>고객지원</h4>
                    <ul>
                        <li><a href="index.html#faq">자주 묻는 질문</a></li>
                        <li><a href="terms.html">이용약관</a></li>
                        <li><a href="privacy.html">개인정보처리방침</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 MarketGrow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Global Config -->
    <script src="js/global-config.js"></script>
    <script src="js/api-utils.js"></script>
    <script src="js/auth-utils.js"></script>
    
    <!-- 설정 파일 로드 -->
    <script src="js/config.js"></script>
    
    <!-- 소셜 로그인 스크립트 -->
    <script src="js/social-login-fix.js"></script>
    
    <!-- 인라인 스크립트로 직접 처리 -->
    <script>
        
        console.log('Login Page Initialized');
        console.log('API URL:', window.API_BASE);

        // 소셜 로그인 버튼 설정
        window.addEventListener('DOMContentLoaded', () => {
            // 이미 로그인된 경우 대시보드로 리디렉션
            const token = localStorage.getItem(window.STORAGE_KEYS.AUTH_TOKEN);
            if (token) {
                window.location.href = '/dashboard.html';
            }

            // 소셜 로그인 버튼 이벤트 리스너
            const kakaoBtn = document.getElementById('kakaoLoginBtn');
            if (kakaoBtn) {
                kakaoBtn.addEventListener('click', function() {
                    if (window.socialLogin && window.socialLogin.loginWithKakaoPopup) {
                        window.socialLogin.loginWithKakaoPopup();
                    } else {
                        alert('카카오 로그인 준비중입니다. 잠시 후 다시 시도해주세요.');
                    }
                });
            }
            
            const googleBtn = document.getElementById('googleLoginBtn');
            if (googleBtn) {
                googleBtn.addEventListener('click', function() {
                    if (window.socialLogin && window.socialLogin.loginWithGoogle) {
                        window.socialLogin.loginWithGoogle();
                    } else {
                        alert('구글 로그인 준비중입니다. 잠시 후 다시 시도해주세요.');
                    }
                });
            }
            
            const naverBtn = document.getElementById('naverLoginBtn');
            if (naverBtn) {
                naverBtn.addEventListener('click', function() {
                    if (window.socialLogin && window.socialLogin.loginWithNaverPopup) {
                        window.socialLogin.loginWithNaverPopup();
                    } else {
                        alert('네이버 로그인 준비중입니다. 잠시 후 다시 시도해주세요.');
                    }
                });
            }

            setTimeout(() => {
                if (window.socialLogin) {
                    console.log('✅ 소셜 로그인 시스템 준비 완료');
                } else {
                    console.error('❌ 소셜 로그인 시스템 로드 실패');
                }
            }, 1000);
        });

        // 로그인 처리
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('username').value?.trim();
            const pwd = document.getElementById('password').value;
            
            if (!id || !pwd) {
                alert('아이디와 비밀번호를 입력하세요');
                return;
            }
            
            console.log('로그인 시도:', id);
            
            try {
                // API 엔드포인트
                const url = '/api/auth';
                console.log('Login URL:', url);
                
                // 서버가 username/email/login 중 아무거나 받을 수 있도록 모두 전송
                const payload = {
                    action: 'login',     // 반드시 포함
                    username: id,        // username으로 전송
                    email: id,           // email로도 전송 (서버가 OR 매칭)
                    login: id,           // 레거시 호환용
                    password: pwd
                };
                console.log('Login payload:', { action: payload.action, id });
                
                // fetch 요청
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                // JSON이 아닐 때 디버깅 도움
                const contentType = response.headers.get('content-type') || '';
                const rawText = await response.text();
                console.log('Raw response:', rawText);
                
                let data;
                try {
                    data = JSON.parse(rawText);
                } catch (parseError) {
                    console.error('JSON 파싱 실패:', parseError);
                    data = { 
                        success: false, 
                        error: 'non_json_response', 
                        raw: rawText.substring(0, 500) 
                    };
                }
                
                console.log('Parsed data:', data);
                
                // auth-utils의 공통 함수 사용
                if (window.authUtils) {
                    const { ok, token, user } = window.authUtils.parseAuthResponse(data);
                    
                    if (!response.ok || !ok) {
                        console.error(`Login failed:`, { status: response.status, data });
                        alert(data?.error || data?.message || `로그인 실패 (${response.status})`);
                        return;
                    }
                    
                    if (!token) {
                        console.error('Token missing in response:', data);
                        alert('로그인 응답에 토큰이 없습니다.');
                        return;
                    }
                    
                    window.authUtils.saveAuthData(token, user);
                    alert('로그인 성공!');
                    window.location.href = 'dashboard.html';
                } else {
                    // Fallback: auth-utils가 로드되지 않았을 때
                    const token = data?.token ?? data?.data?.token;
                    const user = data?.user ?? data?.data?.user;
                    
                    if (!response.ok || !data?.success) {
                        alert(data?.error || '로그인 실패');
                        return;
                    }
                    
                    if (token) {
                        localStorage.setItem('authToken', token);
                        if (user) localStorage.setItem('userInfo', JSON.stringify(user));
                        alert('로그인 성공!');
                        window.location.href = 'dashboard.html';
                    } else {
                        alert('토큰이 없습니다.');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                alert(`서버 연결 실패: ${error.message}`);
            }
        });
        
        // 비밀번호 보기/숨기기
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const icon = document.querySelector('.password-toggle i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // 비밀번호 찾기 (임시)
        function showForgotPassword() {
            alert('비밀번호 찾기 기능은 준비 중입니다.\n관리자에게 문의하세요: marketgrow.kr@gmail.com');
        }
        
        // 고객 지원
        function showSupport() {
            alert('고객 지원: marketgrow.kr@gmail.com\n전화: 010-5772-8658');
        }
    </script>
    <script src="js/mobile-fix.js"></script>
    <script src="script.js"></script>
</body>
</html>