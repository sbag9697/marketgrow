<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MarketGrow 주문하기 - SNS 마케팅 서비스 주문">
    <title>주문하기 - MarketGrow</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mobile-fix.css">
    <link rel="stylesheet" href="order.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <div class="logo-icon">MG</div>
                <h2><a href="index.html">MarketGrow</a></h2>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html">대시보드</a></li>
                <li><a href="services.html">서비스목록</a></li>
                <li><a href="video-keywords.html">영상키워드노출</a></li>
                <li><a href="live-keywords.html">라이브키워드노출</a></li>
                <li class="user-menu">
                    <a href="#" class="user-info" onclick="toggleUserMenu()">
                        <i class="fas fa-user"></i>
                        <span id="navUserName">사용자님</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" onclick="showProfile()"><i class="fas fa-user-edit"></i> 내 정보</a>
                        <a href="#" onclick="showSettings()"><i class="fas fa-cog"></i> 설정</a>
                        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 로그아웃</a>
                    </div>
                </li>
            </ul>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Order Page Content -->
    <div class="order-page">
        <div class="container">
            <!-- 주문 헤더 -->
            <div class="order-header">
                <div class="breadcrumb">
                    <a href="index.html">홈</a>
                    <i class="fas fa-chevron-right"></i>
                    <a href="services.html">서비스목록</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>주문하기</span>
                </div>
                <h1>서비스 주문하기</h1>
                <p>원하는 서비스를 선택하고 맞춤형 마케팅을 시작하세요</p>
            </div>

            <!-- 주문 진행 단계 -->
            <div class="order-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">서비스 선택</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">옵션 설정</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">결제</div>
                </div>
            </div>

            <!-- 주문 콘텐츠 -->
            <div class="order-content">
                <!-- 단계 1: 서비스 선택 -->
                <div class="order-step-content" id="step1">
                    <div class="step-title">
                        <h2>1. 서비스를 선택해주세요</h2>
                        <p>플랫폼과 서비스 유형을 선택하세요</p>
                    </div>

                    <!-- 플랫폼 선택 -->
                    <div class="platform-selection">
                        <h3>플랫폼 선택</h3>
                        <div class="platform-grid" id="platformGrid">
                            <!-- 플랫폼 카드들이 동적으로 로드됩니다 -->
                        </div>
                    </div>

                    <!-- 서비스 목록 -->
                    <div class="service-selection" id="serviceSelection" style="display: none;">
                        <h3>서비스 선택</h3>
                        <div class="service-list" id="serviceList">
                            <!-- 서비스 목록이 동적으로 로드됩니다 -->
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="next-btn" id="step1NextBtn" onclick="goToStep(2)" disabled>
                            다음 단계
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 단계 2: 옵션 설정 -->
                <div class="order-step-content" id="step2" style="display: none;">
                    <div class="step-title">
                        <h2>2. 주문 옵션을 설정해주세요</h2>
                        <p>선택한 서비스의 세부 옵션을 설정하세요</p>
                    </div>

                    <div class="order-form">
                        <div class="form-section">
                            <h3>선택된 서비스</h3>
                            <div class="selected-service" id="selectedServiceInfo">
                                <!-- 선택된 서비스 정보가 표시됩니다 -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>기본 정보</h3>
                            <div class="form-group">
                                <label for="targetUrl">대상 URL <span class="required">*</span></label>
                                <input type="url" id="targetUrl" placeholder="https://instagram.com/username" required>
                                <div class="form-help">마케팅을 진행할 계정이나 게시물의 URL을 입력하세요</div>
                            </div>

                            <div class="form-group">
                                <label for="quantity">수량 <span class="required">*</span></label>
                                <div class="quantity-input">
                                    <button type="button" onclick="changeQuantity(-1)">-</button>
                                    <input type="number" id="quantity" value="100" min="1" required>
                                    <button type="button" onclick="changeQuantity(1)">+</button>
                                </div>
                                <div class="form-help">원하는 수량을 입력하세요 (최소: <span id="minQuantity">1</span>, 최대: <span id="maxQuantity">10000</span>)</div>
                            </div>

                            <div class="form-group">
                                <label for="speed">진행 속도</label>
                                <select id="speed">
                                    <option value="normal">보통 (24-48시간)</option>
                                    <option value="fast">빠름 (12-24시간)</option>
                                    <option value="slow">천천히 (2-7일)</option>
                                </select>
                                <div class="form-help">서비스 진행 속도를 선택하세요</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>추가 옵션</h3>
                            <div class="option-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="guaranteeOption">
                                    <span class="checkmark"></span>
                                    품질 보장 (+20%)
                                </label>
                                <div class="option-description">30일 보장 기간을 제공합니다</div>
                            </div>

                            <div class="option-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="priorityOption">
                                    <span class="checkmark"></span>
                                    우선 처리 (+10%)
                                </label>
                                <div class="option-description">다른 주문보다 우선적으로 처리됩니다</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>특별 요청사항</h3>
                            <div class="form-group">
                                <label for="notes">추가 요청사항</label>
                                <textarea id="notes" placeholder="특별한 요청사항이 있으시면 입력해주세요" rows="4"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="prev-btn" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left"></i>
                            이전 단계
                        </button>
                        <button class="next-btn" onclick="goToStep(3)">
                            다음 단계
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 단계 3: 결제 -->
                <div class="order-step-content" id="step3" style="display: none;">
                    <div class="step-title">
                        <h2>3. 결제를 진행해주세요</h2>
                        <p>주문 내용을 확인하고 결제를 완료하세요</p>
                    </div>

                    <div class="checkout-container">
                        <!-- 주문 요약 -->
                        <div class="order-summary">
                            <h3>주문 요약</h3>
                            <div class="summary-content" id="orderSummary">
                                <!-- 주문 요약이 표시됩니다 -->
                            </div>
                        </div>

                        <!-- 예치금 결제 -->
                        <div class="payment-methods">
                            <h3>결제 방법</h3>
                            <div class="deposit-payment-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <h4 style="margin: 0; color: white;"><i class="fas fa-wallet"></i> 예치금 결제</h4>
                                        <p style="margin: 5px 0; opacity: 0.9;">보유 예치금: <span id="availableBalance" style="font-size: 1.2em; font-weight: bold;">0원</span></p>
                                    </div>
                                    <div id="balanceStatus"></div>
                                </div>
                                <div id="insufficientBalance" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                                    <p style="margin: 0 0 10px 0;"><i class="fas fa-exclamation-circle"></i> 예치금이 부족합니다</p>
                                    <a href="deposit.html" class="btn" style="background: white; color: #667eea; padding: 8px 20px; border-radius: 5px; text-decoration: none; display: inline-block;">
                                        예치금 충전하기
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- 약관 동의 -->
                        <div class="terms-agreement">
                            <label class="checkbox-label">
                                <input type="checkbox" id="agreeTerms" required>
                                <span class="checkmark"></span>
                                <a href="#" onclick="showTerms()">이용약관</a> 및 <a href="#" onclick="showPrivacy()">개인정보처리방침</a>에 동의합니다
                            </label>
                        </div>
                    </div>

                    <div class="step-actions">
                        <button class="prev-btn" onclick="goToStep(2)">
                            <i class="fas fa-arrow-left"></i>
                            이전 단계
                        </button>
                        <button class="order-btn" id="orderBtn" onclick="submitOrder()">
                            <i class="fas fa-credit-card"></i>
                            주문하기
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>MarketGrow</h3>
                    <p>24시간 SNS 마케팅 전문 서비스</p>
                </div>
                <div class="footer-links">
                    <h4>서비스</h4>
                    <ul>
                        <li><a href="services.html">전체 서비스</a></li>
                        <li><a href="order-method.html">주문 방법</a></li>
                        <li><a href="blog.html">마케팅 블로그</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>고객지원</h4>
                    <ul>
                        <li><a href="index.html#faq">자주 묻는 질문</a></li>
                        <li><a href="terms.html">이용약관</a></li>
                        <li><a href="privacy.html">개인정보처리방침</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 MarketGrow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- KG이니시스 SDK는 js/kg-inicis.js에서 동적 로드 -->
    
    <!-- 인라인 스크립트로 모든 JS 로직 통합 -->
    <script>
    // Configuration
    const API_BASE_URL = 'https://marketgrow-production.up.railway.app/api';
    
    // API utilities
    const api = {
        token: localStorage.getItem('authToken'),
        
        setToken(token) {
            this.token = token;
            localStorage.setItem('authToken', token);
        },
        
        clearToken() {
            this.token = null;
            localStorage.removeItem('authToken');
        },
        
        async request(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (this.token) {
                headers['Authorization'] = `Bearer ${this.token}`;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${url}`, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API 요청 실패');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        },
        
        async getServices() {
            return this.request('/services');
        },
        
        async getServiceById(id) {
            return this.request(`/services/${id}`);
        },
        
        async getProfile() {
            return this.request('/auth/profile');
        }
    };
    
    // Notification Manager
    const NotificationManager = {
        show(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        },
        
        success(message) { this.show(message, 'success'); },
        error(message) { this.show(message, 'error'); },
        warning(message) { this.show(message, 'warning'); },
        info(message) { this.show(message, 'info'); }
    };
    
    // Order page logic
    let currentStep = 1;
    let selectedPlatform = null;
    let selectedService = null;
    let orderData = {};
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded');
        checkAuthentication();
        initOrderPage();
        checkUrlParams();
    });
    
    async function checkAuthentication() {
        if (!api.token) {
            NotificationManager.warning('로그인이 필요한 서비스입니다.');
            window.location.href = 'login.html';
            return;
        }
        
        try {
            const response = await api.getProfile();
            if (!response.success) {
                throw new Error('인증 실패');
            }
            
            const navUserName = document.getElementById('navUserName');
            if (navUserName) {
                navUserName.textContent = `${response.data.user.name}님`;
            }
        } catch (error) {
            console.error('인증 확인 실패:', error);
            api.clearToken();
            window.location.href = 'login.html';
        }
    }
    
    function initOrderPage() {
        loadPlatforms();
        updateStepUI();
    }
    
    function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const platform = urlParams.get('platform');
        const serviceId = urlParams.get('service');
        
        if (platform) {
            selectedPlatform = platform;
            loadServicesForPlatform(platform);
        }
        
        if (serviceId) {
            loadSpecificService(serviceId);
        }
    }
    
    async function loadPlatforms() {
        const platformGrid = document.getElementById('platformGrid');
        if (!platformGrid) return;
        
        try {
            const response = await api.getServices();
            
            if (response.success) {
                const platforms = groupServicesByPlatform(response.data.services);
                renderPlatforms(platforms);
            }
        } catch (error) {
            console.error('플랫폼 로드 오류:', error);
            platformGrid.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>플랫폼 목록을 불러올 수 없습니다.</p>
                    <button class="retry-btn" onclick="loadPlatforms()">다시 시도</button>
                </div>
            `;
        }
    }
    
    function groupServicesByPlatform(services) {
        const platformMap = {};
        
        services.forEach(service => {
            if (!platformMap[service.platform]) {
                platformMap[service.platform] = {
                    name: getPlatformName(service.platform),
                    icon: getPlatformIcon(service.platform),
                    count: 0,
                    services: []
                };
            }
            platformMap[service.platform].count++;
            platformMap[service.platform].services.push(service);
        });
        
        return platformMap;
    }
    
    function renderPlatforms(platforms) {
        const platformGrid = document.getElementById('platformGrid');
        
        let platformsHTML = '';
        Object.keys(platforms).forEach(platform => {
            const platformData = platforms[platform];
            platformsHTML += `
                <div class="platform-card ${selectedPlatform === platform ? 'selected' : ''}" 
                     onclick="selectPlatform('${platform}', event)">
                    <i class="${platformData.icon}"></i>
                    <h4>${platformData.name}</h4>
                    <p>${platformData.count}개 서비스</p>
                </div>
            `;
        });
        
        platformGrid.innerHTML = platformsHTML;
    }
    
    async function selectPlatform(platform, event) {
        console.log('selectPlatform:', platform);
        selectedPlatform = platform;
        selectedService = null;
        
        document.querySelectorAll('.platform-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        const clickedCard = event ? event.currentTarget : document.querySelector(`.platform-card[onclick*="${platform}"]`);
        if (clickedCard) {
            clickedCard.classList.add('selected');
        }
        
        await loadServicesForPlatform(platform);
        
        const serviceSelection = document.getElementById('serviceSelection');
        serviceSelection.style.display = 'block';
        serviceSelection.scrollIntoView({ behavior: 'smooth' });
        
        updateNextButton();
    }
    
    async function loadServicesForPlatform(platform) {
        const serviceList = document.getElementById('serviceList');
        if (!serviceList) return;
        
        serviceList.innerHTML = `
            <div class="loading-placeholder">
                <i class="fas fa-spinner fa-spin"></i>
                <p>서비스 목록을 불러오는 중...</p>
            </div>
        `;
        
        try {
            const response = await api.getServices();
            
            if (response.success && response.data && response.data.services) {
                const filteredServices = response.data.services.filter(service => 
                    service.platform === platform
                );
                renderServices(filteredServices);
            }
        } catch (error) {
            console.error('서비스 로드 오류:', error);
            serviceList.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>서비스 목록을 불러올 수 없습니다.</p>
                    <button class="retry-btn" onclick="loadServicesForPlatform('${platform}')">다시 시도</button>
                </div>
            `;
        }
    }
    
    function renderServices(services) {
        const serviceList = document.getElementById('serviceList');
        
        if (!services || services.length === 0) {
            serviceList.innerHTML = '<p>이 플랫폼에는 아직 서비스가 없습니다.</p>';
            return;
        }
        
        let servicesHTML = '';
        services.forEach(service => {
            try {
                let priceDisplay = '가격 정보 없음';
                if (service.pricing && Array.isArray(service.pricing) && service.pricing.length > 0) {
                    const firstPricing = service.pricing[0];
                    if (firstPricing && typeof firstPricing.price === 'number' && typeof firstPricing.quantity === 'number') {
                        const price = firstPricing.price;
                        const quantity = firstPricing.quantity;
                        if (quantity > 0) {
                            const pricePerThousand = Math.round((price / quantity) * 1000);
                            priceDisplay = `₩${pricePerThousand.toLocaleString()}/1000개`;
                        }
                    }
                }
                
                servicesHTML += `
                    <div class="service-item ${selectedService && selectedService._id === service._id ? 'selected' : ''}" 
                         onclick="selectService('${service._id}')">
                        <input type="radio" name="service" value="${service._id}" 
                               ${selectedService && selectedService._id === service._id ? 'checked' : ''}>
                        <div class="service-info">
                            <h4>${service.name || '서비스명 없음'}</h4>
                            <p>${service.description || '설명 없음'}</p>
                            <div class="service-meta">
                                <span>최소: ${service.minQuantity || 0}개</span>
                                <span>최대: ${service.maxQuantity || 0}개</span>
                                <span>배송: ${service.deliveryTime?.min || 0}-${service.deliveryTime?.max || 0} ${service.deliveryTime?.unit === 'hours' ? '시간' : '일'}</span>
                                <span>보장: ${service.guaranteePeriod || 0}일</span>
                            </div>
                        </div>
                        <div class="service-price">
                            ${priceDisplay}
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('서비스 렌더링 오류:', err, service);
            }
        });
        
        serviceList.innerHTML = servicesHTML;
    }
    
    async function selectService(serviceId) {
        console.log('selectService:', serviceId);
        try {
            const response = await api.getServiceById(serviceId);
            if (response.success && response.data) {
                selectedService = response.data.service || response.data;
                
                document.querySelectorAll('.service-item').forEach(item => {
                    item.classList.remove('selected');
                    const radio = item.querySelector('input[type="radio"]');
                    if (radio) radio.checked = false;
                });
                
                const selectedItem = document.querySelector(`.service-item[onclick*="${serviceId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                    const radio = selectedItem.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;
                }
                
                updateNextButton();
            }
        } catch (error) {
            console.error('서비스 선택 오류:', error);
            NotificationManager.error('서비스 정보를 불러올 수 없습니다.');
        }
    }
    
    function updateNextButton() {
        const nextBtn = document.getElementById('step1NextBtn');
        if (nextBtn) {
            nextBtn.disabled = !selectedPlatform || !selectedService;
        }
    }
    
    function goToStep(step) {
        if (step === 2 && (!selectedPlatform || !selectedService)) {
            NotificationManager.warning('플랫폼과 서비스를 선택해주세요.');
            return;
        }
        
        currentStep = step;
        updateStepUI();
    }
    
    function updateStepUI() {
        document.querySelectorAll('.step').forEach((step, index) => {
            if (index + 1 < currentStep) {
                step.classList.add('completed');
                step.classList.remove('active');
            } else if (index + 1 === currentStep) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active', 'completed');
            }
        });
        
        document.querySelectorAll('.order-step-content').forEach((content, index) => {
            const stepNumber = index + 1;
            content.style.display = stepNumber === currentStep ? 'block' : 'none';
        });
    }
    
    function getPlatformName(platform) {
        const platformNames = {
            instagram: '인스타그램',
            youtube: '유튜브',
            facebook: '페이스북',
            twitter: '트위터',
            tiktok: '틱톡',
            telegram: '텔레그램',
            threads: '스레드',
            website: '웹사이트'
        };
        return platformNames[platform] || platform;
    }
    
    function getPlatformIcon(platform) {
        const platformIcons = {
            instagram: 'fab fa-instagram',
            youtube: 'fab fa-youtube',
            facebook: 'fab fa-facebook',
            twitter: 'fab fa-twitter',
            tiktok: 'fab fa-tiktok',
            telegram: 'fab fa-telegram',
            threads: 'fab fa-threads',
            website: 'fas fa-globe'
        };
        return platformIcons[platform] || 'fas fa-globe';
    }
    
    // Global functions
    window.selectPlatform = selectPlatform;
    window.selectService = selectService;
    window.loadPlatforms = loadPlatforms;
    window.loadServicesForPlatform = loadServicesForPlatform;
    window.goToStep = goToStep;
    window.changeQuantity = function(amount) {
        const quantityInput = document.getElementById('quantity');
        if (!quantityInput) return;
        
        const currentValue = parseInt(quantityInput.value) || 0;
        const newValue = currentValue + amount;
        const minQuantity = parseInt(document.getElementById('minQuantity')?.textContent) || 1;
        const maxQuantity = parseInt(document.getElementById('maxQuantity')?.textContent) || 10000;
        
        if (newValue >= minQuantity && newValue <= maxQuantity) {
            quantityInput.value = newValue;
        }
    };
    // 예치금 잔액 확인
    async function checkDepositBalance() {
        try {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            const response = await fetch(API_CONFIG.BASE_URL + '/users/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const balance = data.data.depositBalance || 0;
                document.getElementById('availableBalance').textContent = balance.toLocaleString() + '원';
                
                // 주문 금액과 비교
                const orderAmount = parseInt(document.getElementById('totalAmount')?.textContent.replace(/[^0-9]/g, '') || '0');
                
                if (balance < orderAmount) {
                    document.getElementById('insufficientBalance').style.display = 'block';
                    document.getElementById('orderBtn').disabled = true;
                    document.getElementById('orderBtn').innerHTML = '<i class="fas fa-exclamation-circle"></i> 예치금 부족';
                    document.getElementById('orderBtn').style.background = '#94a3b8';
                } else {
                    document.getElementById('insufficientBalance').style.display = 'none';
                    document.getElementById('orderBtn').disabled = false;
                    document.getElementById('orderBtn').innerHTML = '<i class="fas fa-check-circle"></i> 예치금으로 결제';
                }
                
                return balance;
            }
        } catch (error) {
            console.error('예치금 확인 실패:', error);
        }
        return 0;
    }

    // 페이지 로드 시 예치금 확인
    checkDepositBalance();

    window.submitOrder = async function() {
        const agreeTerms = document.getElementById('agreeTerms').checked;
        if (!agreeTerms) {
            alert('이용약관에 동의해주세요.');
            return;
        }

        const balance = await checkDepositBalance();
        const orderAmount = parseInt(document.getElementById('totalAmount')?.textContent.replace(/[^0-9]/g, '') || '0');
        
        if (balance < orderAmount) {
            alert('예치금이 부족합니다. 충전 후 이용해주세요.');
            window.location.href = 'deposit.html';
            return;
        }

        // 예치금으로 결제 처리
        const orderData = {
            serviceId: currentOrder.serviceId,
            quantity: currentOrder.quantity,
            targetUrl: currentOrder.targetUrl,
            targetUsername: currentOrder.targetUsername,
            paymentMethod: 'deposit', // 예치금 결제
            totalAmount: orderAmount
        };

        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch(API_CONFIG.BASE_URL + '/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                const result = await response.json();
                alert('주문이 완료되었습니다!');
                window.location.href = 'order-success.html?orderId=' + result.data.order._id;
            } else {
                const error = await response.json();
                alert('주문 실패: ' + (error.message || '다시 시도해주세요'));
            }
        } catch (error) {
            console.error('주문 처리 오류:', error);
            alert('주문 처리 중 오류가 발생했습니다.');
        }
    };
    window.toggleUserMenu = function() {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    };
    window.showProfile = function() {
        console.log('프로필 표시');
    };
    window.showSettings = function() {
        console.log('설정 표시');
    };
    window.logout = function() {
        api.clearToken();
        window.location.href = 'login.html';
    };
    window.showTerms = function() {
        console.log('이용약관 표시');
    };
    window.showPrivacy = function() {
        console.log('개인정보처리방침 표시');
    };
    </script>
    
    <style>
    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        z-index: 10000;
    }
    
    .notification.show {
        transform: translateX(0);
    }
    
    .notification-success {
        border-left: 4px solid #4CAF50;
    }
    
    .notification-error {
        border-left: 4px solid #f44336;
    }
    
    .notification-warning {
        border-left: 4px solid #ff9800;
    }
    
    .notification-info {
        border-left: 4px solid #2196F3;
    }
    
    .notification i {
        font-size: 20px;
    }
    
    .notification-success i { color: #4CAF50; }
    .notification-error i { color: #f44336; }
    .notification-warning i { color: #ff9800; }
    .notification-info i { color: #2196F3; }
    </style>
    <script src="js/mobile-fix.js"></script>
    <script src="script.js"></script>
</body>
</html>