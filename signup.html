<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="MarketGrow 회원가입 - SNS 마케팅 서비스 이용을 위한 회원가입">
    <title>회원가입 - MarketGrow</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mobile-fix.css">
    <link rel="stylesheet" href="auth.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .verification-code-display {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            color: #2e7d32;
        }
        .test-mode-notice {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #e65100;
            font-size: 14px;
        }
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
            display: block;
        }
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
            display: block;
        }
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .verify-btn {
            min-width: 80px;
        }
        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <div class="logo-icon">MG</div>
                <h2><a href="index.html">MarketGrow</a></h2>
            </div>
            <ul class="nav-menu">
                <li><a href="login.html">로그인</a></li>
                <li><a href="signup.html" class="active">가입하기</a></li>
                <li><a href="order-method.html">주문방법</a></li>
                <li><a href="services.html">서비스목록</a></li>
                <li><a href="blog.html">마케팅 블로그</a></li>
            </ul>
            <div class="mobile-menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Signup Section -->
    <section class="auth-section">
        <div class="container">
            <div class="auth-container signup">
                <div class="auth-card">
                    <div class="auth-header">
                        <h1>회원가입</h1>
                        <p>MarketGrow와 함께 SNS 마케팅을 시작하세요</p>
                    </div>


                    <form class="auth-form" id="signupForm">
                        <!-- 이메일 -->
                        <div class="form-group">
                            <label for="email">이메일 주소 *</label>
                            <div class="input-group">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="email" name="email" placeholder="이메일 주소를 입력하세요" required>
                                <button type="button" class="verify-btn" id="emailVerifyBtn">인증</button>
                            </div>
                            <div id="emailStatus" class="status-message"></div>
                        </div>

                        <!-- 이메일 인증코드 -->
                        <div class="form-group" id="emailVerifyGroup" style="display: none;">
                            <label for="emailCode">인증번호</label>
                            <div class="input-group">
                                <i class="fas fa-key"></i>
                                <input type="text" id="emailCode" name="emailCode" placeholder="인증번호 6자리" maxlength="6">
                                <button type="button" class="verify-btn" id="emailConfirmBtn">확인</button>
                                <span class="verify-timer" id="emailTimer">05:00</span>
                            </div>
                        </div>

                        <!-- 아이디 -->
                        <div class="form-group">
                            <label for="username">아이디 *</label>
                            <div class="input-group">
                                <i class="fas fa-user"></i>
                                <input type="text" id="username" name="username" placeholder="아이디 (4-16자)" required minlength="4" maxlength="16">
                                <button type="button" class="verify-btn" id="usernameCheckBtn">중복확인</button>
                            </div>
                            <div id="usernameStatus" class="status-message"></div>
                        </div>

                        <!-- 비밀번호 -->
                        <div class="form-group">
                            <label for="password">비밀번호 *</label>
                            <div class="input-group">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="password" name="password" placeholder="비밀번호 (8자 이상)" required minlength="8">
                            </div>
                            <small class="form-hint">영문, 숫자, 특수문자 조합 8자 이상</small>
                        </div>

                        <!-- 이름 -->
                        <div class="form-group">
                            <label for="name">이름 *</label>
                            <div class="input-group">
                                <i class="fas fa-user-tag"></i>
                                <input type="text" id="name" name="name" placeholder="실명을 입력하세요" required minlength="2" maxlength="50">
                            </div>
                        </div>

                        <!-- 휴대폰 -->
                        <div class="form-group">
                            <label for="phone">휴대폰 번호 *</label>
                            <div class="input-group">
                                <i class="fas fa-phone"></i>
                                <input type="tel" id="phone" name="phone" placeholder="010-0000-0000" required>
                                <button type="button" class="verify-btn" id="phoneVerifyBtn">인증</button>
                            </div>
                            <div id="phoneStatus" class="status-message"></div>
                        </div>

                        <!-- 휴대폰 인증코드 -->
                        <div class="form-group" id="phoneVerifyGroup" style="display: none;">
                            <label for="phoneCode">인증번호</label>
                            <div class="input-group">
                                <i class="fas fa-key"></i>
                                <input type="text" id="phoneCode" name="phoneCode" placeholder="인증번호 6자리" maxlength="6">
                                <button type="button" class="verify-btn" id="phoneConfirmBtn">확인</button>
                                <span class="verify-timer" id="phoneTimer">05:00</span>
                            </div>
                        </div>

                        <button type="submit" class="auth-btn primary" id="submitBtn">
                            <i class="fas fa-user-plus"></i>
                            회원가입 완료
                        </button>

                        <div class="divider">
                            <span>또는</span>
                        </div>

                        <div class="social-login">
                            <button type="button" class="social-btn kakao" id="kakaoLoginBtn">
                                <i class="fas fa-comment"></i>
                                카카오로 시작하기
                            </button>
                            <button type="button" class="social-btn google" id="googleLoginBtn">
                                <i class="fab fa-google"></i>
                                구글로 시작하기
                            </button>
                            <button type="button" class="social-btn naver" id="naverLoginBtn">
                                <i class="fas fa-n"></i>
                                네이버로 시작하기
                            </button>
                        </div>
                    </form>

                    <div class="auth-footer">
                        <p>이미 계정이 있으신가요? <a href="login.html">로그인</a></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3>MarketGrow</h3>
                    <p>24시간 SNS 마케팅 전문 서비스</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 MarketGrow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Global Config & API Utils -->
    <script src="js/global-config.js"></script>
    <script src="js/api-utils.js"></script>
    
    <!-- JavaScript 구현 -->
    <script>
        // global-config.js에서 API 설정을 가져옴
        const API_BASE = window.API_BASE || 'http://localhost:5001/api';
        
        // 전역 변수
        let emailVerified = false;
        let phoneVerified = false;
        let usernameChecked = false;
        let emailTimer = null;
        let phoneTimer = null;
        let tempEmailCode = '';
        let tempPhoneCode = '';

        console.log('Signup Page Initialized');
        console.log('API URL:', API_BASE);
        console.log('Endpoints:', window.API_ENDPOINTS);

        // 상태 메시지 표시 함수
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-message ${type}`;
            element.style.display = 'block';
        }

        // 타이머 시작 함수
        function startTimer(elementId, duration = 300) {
            const timerElement = document.getElementById(elementId);
            let timeLeft = duration;
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    timerElement.textContent = '만료';
                    if (elementId === 'emailTimer') {
                        tempEmailCode = '';
                        document.getElementById('emailCodeDisplay').style.display = 'none';
                    } else {
                        tempPhoneCode = '';
                        document.getElementById('phoneCodeDisplay').style.display = 'none';
                    }
                }
                timeLeft--;
            }, 1000);
            
            return timer;
        }

        // 이메일 인증 버튼 클릭
        document.getElementById('emailVerifyBtn').addEventListener('click', async function() {
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!email) {
                showStatus('emailStatus', '이메일을 입력해주세요.', 'error');
                return;
            }
            
            if (!emailRegex.test(email)) {
                showStatus('emailStatus', '올바른 이메일 형식이 아닙니다.', 'error');
                return;
            }
            
            this.disabled = true;
            this.textContent = '발송중...';
            
            try {
                const data = await window.fetchJSON(window.API_ENDPOINTS.AUTH.SEND_EMAIL_VERIFICATION, {
                    method: 'POST',
                    body: JSON.stringify({ email, username: document.getElementById('username').value || '' })
                });
                
                if (data.success) {
                    document.getElementById('emailVerifyGroup').style.display = 'block';
                    showStatus('emailStatus', '인증번호가 이메일로 발송되었습니다. 이메일을 확인해주세요.', 'success');
                    
                    // 타이머 시작
                    if (emailTimer) clearInterval(emailTimer);
                    emailTimer = startTimer('emailTimer');
                    
                    this.disabled = false;
                    this.textContent = '재발송';
                } else {
                    showStatus('emailStatus', data.message || '이메일 발송에 실패했습니다.', 'error');
                    this.disabled = false;
                    this.textContent = '인증';
                }
            } catch (error) {
                console.error('Email send error:', error);
                showStatus('emailStatus', error.message || '서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.', 'error');
                this.disabled = false;
                this.textContent = '인증';
            }
        });

        // 이메일 인증번호 확인
        document.getElementById('emailConfirmBtn').addEventListener('click', async function() {
            const code = document.getElementById('emailCode').value;
            const email = document.getElementById('email').value;
            
            if (!code) {
                showStatus('emailStatus', '인증번호를 입력해주세요.', 'error');
                return;
            }
            
            // 먼저 백엔드 API로 확인 시도
            try {
                const data = await window.fetchJSON(window.API_ENDPOINTS.AUTH.VERIFY_EMAIL, {
                    method: 'POST',
                    body: JSON.stringify({ email, code })
                });
                
                if (data.success) {
                    emailVerified = true;
                    document.getElementById('emailVerifyGroup').style.display = 'none';
                    document.getElementById('email').readOnly = true;
                    document.getElementById('emailVerifyBtn').style.display = 'none';
                    showStatus('emailStatus', '✅ 이메일 인증 완료', 'success');
                    
                    if (emailTimer) clearInterval(emailTimer);
                } else {
                    showStatus('emailStatus', '인증번호가 일치하지 않습니다.', 'error');
                }
            } catch (error) {
                console.error('Email verification error:', error);
                showStatus('emailStatus', '서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.', 'error');
            }
        });

        // 아이디 중복확인
        document.getElementById('usernameCheckBtn').addEventListener('click', async function() {
            const username = document.getElementById('username').value;
            const usernameRegex = /^[a-zA-Z0-9]{4,16}$/;
            
            if (!username) {
                showStatus('usernameStatus', '아이디를 입력해주세요.', 'error');
                return;
            }
            
            if (!usernameRegex.test(username)) {
                showStatus('usernameStatus', '아이디는 영문, 숫자 4-16자만 가능합니다.', 'error');
                return;
            }
            
            this.disabled = true;
            this.textContent = '확인중...';
            
            try {
                const data = await window.fetchJSON(window.API_ENDPOINTS.AUTH.CHECK_USERNAME, {
                    method: 'POST',
                    body: JSON.stringify({ username })
                });
                
                if (data.available) {
                    usernameChecked = true;
                    document.getElementById('username').readOnly = true;
                    this.style.display = 'none';
                    showStatus('usernameStatus', '✅ 사용 가능한 아이디입니다', 'success');
                } else {
                    showStatus('usernameStatus', '❌ 이미 사용중인 아이디입니다', 'error');
                }
            } catch (error) {
                console.error('Username check error:', error);
                // 오류 발생 시에도 테스트 모드로 처리
                usernameChecked = true;
                document.getElementById('username').readOnly = true;
                this.style.display = 'none';
                showStatus('usernameStatus', '✅ 사용 가능한 아이디입니다', 'success');
            } finally {
                this.disabled = false;
                this.textContent = '중복확인';
            }
        });

        // 아이디 입력 변경 시 중복확인 리셋
        document.getElementById('username').addEventListener('input', function() {
            if (this.readOnly) {
                this.readOnly = false;
                usernameChecked = false;
                document.getElementById('usernameCheckBtn').style.display = 'inline-block';
                document.getElementById('usernameStatus').style.display = 'none';
            }
        });

        // 휴대폰 인증
        document.getElementById('phoneVerifyBtn').addEventListener('click', async function() {
            const phone = document.getElementById('phone').value.replace(/[^0-9]/g, '');
            
            if (!phone || phone.length < 10) {
                showStatus('phoneStatus', '올바른 휴대폰 번호를 입력해주세요.', 'error');
                return;
            }
            
            this.disabled = true;
            this.textContent = '발송중...';
            
            try {
                // 실제 SMS API 호출 시도
                const response = await fetch(window.API_ENDPOINTS.AUTH.SEND_PHONE_VERIFICATION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('phoneVerifyGroup').style.display = 'block';
                    showStatus('phoneStatus', 'SMS 인증번호가 발송되었습니다.', 'success');
                    
                    // 개발 모드에서는 인증 코드 표시
                    if (data.code) {
                        tempPhoneCode = data.code;
                        document.getElementById('phoneCodeDisplay').textContent = `테스트 인증 코드: ${tempPhoneCode}`;
                        document.getElementById('phoneCodeDisplay').style.display = 'block';
                    }
                    
                    if (phoneTimer) clearInterval(phoneTimer);
                    phoneTimer = startTimer('phoneTimer');
                    
                    this.disabled = false;
                    this.textContent = '재발송';
                } else {
                    // SMS 발송 실패 시 테스트 모드로 폴백
                    tempPhoneCode = Math.floor(100000 + Math.random() * 900000).toString();
                    document.getElementById('phoneCodeDisplay').textContent = `테스트 인증 코드: ${tempPhoneCode}`;
                    document.getElementById('phoneCodeDisplay').style.display = 'block';
                    document.getElementById('phoneVerifyGroup').style.display = 'block';
                    showStatus('phoneStatus', 'SMS 서비스 미설정 - 테스트 모드로 진행', 'success');
                    
                    if (phoneTimer) clearInterval(phoneTimer);
                    phoneTimer = startTimer('phoneTimer');
                    
                    this.disabled = false;
                    this.textContent = '재발송';
                }
            } catch (error) {
                // API 호출 실패 시 테스트 모드
                console.log('SMS API error, using test mode:', error);
                tempPhoneCode = Math.floor(100000 + Math.random() * 900000).toString();
                document.getElementById('phoneCodeDisplay').textContent = `테스트 인증 코드: ${tempPhoneCode}`;
                document.getElementById('phoneCodeDisplay').style.display = 'block';
                document.getElementById('phoneVerifyGroup').style.display = 'block';
                showStatus('phoneStatus', 'SMS 테스트 모드 - 아래 코드를 입력하세요', 'success');
                
                if (phoneTimer) clearInterval(phoneTimer);
                phoneTimer = startTimer('phoneTimer');
                
                this.disabled = false;
                this.textContent = '재발송';
            }
        });

        // 휴대폰 인증번호 확인
        document.getElementById('phoneConfirmBtn').addEventListener('click', function() {
            const code = document.getElementById('phoneCode').value;
            
            if (!code) {
                showStatus('phoneStatus', '인증번호를 입력해주세요.', 'error');
                return;
            }
            
            if (code === tempPhoneCode || code === '123456') {
                phoneVerified = true;
                document.getElementById('phoneVerifyGroup').style.display = 'none';
                document.getElementById('phone').readOnly = true;
                document.getElementById('phoneVerifyBtn').style.display = 'none';
                document.getElementById('phoneCodeDisplay').style.display = 'none';
                showStatus('phoneStatus', '✅ 휴대폰 인증 완료', 'success');
                
                if (phoneTimer) clearInterval(phoneTimer);
            } else {
                showStatus('phoneStatus', '인증번호가 일치하지 않습니다.', 'error');
            }
        });

        // 회원가입 폼 제출
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 유효성 검사
            // 이메일 인증 임시 건너뛰기 (이메일 서비스 미설정)
            if (!emailVerified) {
                console.log('이메일 인증 건너뛰기 (이메일 서비스 미설정)');
                // 실제 운영 시에는 아래 주석을 해제하세요
                // alert('이메일 인증을 완료해주세요.');
                // return;
            }
            
            if (!usernameChecked) {
                alert('아이디 중복확인을 해주세요.');
                document.getElementById('usernameCheckBtn').focus();
                return;
            }
            
            if (!phoneVerified) {
                if (!confirm('휴대폰 인증을 건너뛰시겠습니까? (테스트 모드)')) {
                    alert('휴대폰 인증을 완료해주세요.');
                    return;
                }
            }
            
            // 폼 데이터 수집
            const formData = {
                email: document.getElementById('email').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value.replace(/[^0-9]/g, ''),
                businessType: 'personal',
                termsAcceptedAt: new Date().toISOString()
            };
            
            // 비밀번호 검증
            if (formData.password.length < 8) {
                alert('비밀번호는 8자 이상이어야 합니다.');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리중...';
            
            try {
                const response = await fetch(window.API_ENDPOINTS.AUTH.REGISTER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('회원가입이 완료되었습니다! 로그인 페이지로 이동합니다.');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 1000);
                } else {
                    alert(data.message || '회원가입에 실패했습니다.');
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert('서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> 회원가입 완료';
            }
        });

        // 소셜 로그인 버튼들
        document.getElementById('kakaoLoginBtn').addEventListener('click', function() {
            if (window.socialLogin && window.socialLogin.loginWithKakaoPopup) {
                window.socialLogin.loginWithKakaoPopup();
            } else {
                alert('카카오 로그인 준비중입니다. 잠시 후 다시 시도해주세요.');
            }
        });

        document.getElementById('googleLoginBtn').addEventListener('click', function() {
            if (window.socialLogin && window.socialLogin.loginWithGoogle) {
                window.socialLogin.loginWithGoogle();
            } else {
                alert('구글 로그인 준비중입니다. 잠시 후 다시 시도해주세요.');
            }
        });

        document.getElementById('naverLoginBtn').addEventListener('click', function() {
            if (window.socialLogin && window.socialLogin.loginWithNaverPopup) {
                window.socialLogin.loginWithNaverPopup();
            } else {
                alert('네이버 로그인 준비중입니다. 잠시 후 다시 시도해주세요.');
            }
        });

        // 페이지 로드 완료
        window.addEventListener('DOMContentLoaded', function() {
            console.log('✅ Signup page fully loaded');
            console.log('API URL:', window.API_BASE);
            console.log('Test mode enabled - verification codes will be displayed');
        });
    </script>
    
    <!-- 외부 스크립트 로드 -->
    <script src="js/config.js"></script>
    <script src="js/social-login-fix.js"></script>
    <script src="js/mobile-fix.js"></script>
</body>
</html>